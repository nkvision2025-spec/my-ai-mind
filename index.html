<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal AI Mind</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 overflow-hidden">

<div id="app" class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-72 bg-slate-950 border-r border-slate-800 p-4">
        <div class="flex items-center gap-2 mb-8 px-2">
            <i data-lucide="brain-circuit" class="w-8 h-8 text-blue-400"></i>
            <h1 class="text-xl font-bold tracking-tight text-white">My AI Mind</h1>
        </div>
        
        <div class="flex-1 overflow-y-auto space-y-4 custom-scrollbar">
            <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider px-2">Knowledge Base</div>
            <div id="knowledge-list" class="space-y-2">
                <!-- Knowledge items will be injected here -->
                <p class="text-sm text-slate-500 px-2 italic">No documents uploaded yet.</p>
            </div>
        </div>

        <div class="mt-auto pt-4 space-y-3 border-t border-slate-800">
            <div class="flex items-center justify-between px-2">
                <span class="text-xs text-slate-400">Language</span>
                <select id="lang-select" class="bg-slate-800 text-xs rounded border border-slate-700 px-2 py-1 outline-none focus:border-blue-500">
                    <option value="en">English</option>
                    <option value="hi">Hindi (हिन्दी)</option>
                    <option value="gu">Gujarati (ગુજરાતી)</option>
                </select>
            </div>
            <button onclick="clearMemory()" class="w-full flex items-center justify-center gap-2 py-2 px-4 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-all text-sm font-medium">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Clear Memory
            </button>
        </div>
    </aside>

    <!-- Main Chat -->
    <main class="flex-1 flex flex-col min-w-0">
        <!-- Header -->
        <header class="p-4 border-b border-slate-800 flex items-center justify-between md:hidden">
            <div class="flex items-center gap-2">
                <i data-lucide="brain-circuit" class="w-6 h-6 text-blue-400"></i>
                <span class="font-bold">AI Mind</span>
            </div>
        </header>

        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 custom-scrollbar">
            <!-- Welcome View -->
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-4 max-w-md mx-auto">
                <div class="w-20 h-20 bg-blue-500/10 rounded-full flex items-center justify-center">
                    <i data-lucide="brain-circuit" class="w-10 h-10 text-blue-500 animate-pulse"></i>
                </div>
                <h2 class="text-2xl font-bold">Aapka Personalized Mind Taiyar Hai</h2>
                <p class="text-slate-400">Koi bhi document ya image upload karein. Main sab yaad rakhunga.</p>
            </div>
        </div>

        <!-- Input Section -->
        <div class="p-4 bg-slate-900 border-t border-slate-800">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-end gap-2 bg-slate-800/50 border border-slate-700 rounded-2xl p-2 focus-within:ring-2 ring-blue-500/50 transition-all">
                    <button onclick="document.getElementById('file-input').click()" class="p-3 text-slate-400 hover:text-blue-400 hover:bg-slate-700 rounded-xl transition-all shrink-0">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                    <input type="file" id="file-input" class="hidden" accept=".pdf,.doc,.docx,.txt,image/*">
                    
                    <textarea id="user-input" placeholder="Sawal puchein..." rows="1" class="flex-1 bg-transparent border-none outline-none py-3 px-2 resize-none text-slate-200 placeholder:text-slate-500 max-h-32"></textarea>

                    <button id="send-btn" class="p-3 rounded-xl bg-slate-700 text-slate-500 transition-all shrink-0">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-[10px] text-center text-slate-600 mt-2 uppercase tracking-widest font-semibold">
                    Multi-Language AI Assistant (Hindi, English, Gujarati)
                </p>
            </div>
        </div>
    </main>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configuration
    const firebaseConfig = JSON.parse(__firebase_config);
    const apiKey = ""; // Gemini API Key
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'html-ai-mind-001';

    // Global Services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let knowledgeBase = [];

    // Initialize UI
    lucide.createIcons();

    const chatContainer = document.getElementById('chat-messages');
    const welcomeScreen = document.getElementById('welcome-screen');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const knowledgeList = document.getElementById('knowledge-list');
    const langSelect = document.getElementById('lang-select');

    // 1. Auth Flow
    const initAuth = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    };

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            setupListeners(user.uid);
        }
    });

    initAuth();

    // 2. Firestore Listeners
    function setupListeners(userId) {
        // Chat History
        const chatPath = collection(db, 'artifacts', appId, 'users', userId, 'chats');
        onSnapshot(chatPath, (snapshot) => {
            const messages = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderMessages(messages.sort((a, b) => a.timestamp - b.timestamp));
        }, (err) => console.error(err));

        // Knowledge Base
        const kbPath = collection(db, 'artifacts', appId, 'users', userId, 'knowledge');
        onSnapshot(kbPath, (snapshot) => {
            knowledgeBase = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderKnowledge();
        });
    }

    // 3. Render Functions
    function renderMessages(messages) {
        if (messages.length > 0) welcomeScreen.classList.add('hidden');
        else welcomeScreen.classList.remove('hidden');

        chatContainer.innerHTML = '';
        if (messages.length === 0) chatContainer.appendChild(welcomeScreen);

        messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            let bgClass = 'bg-slate-800 text-slate-200 border border-slate-700/50';
            if (msg.sender === 'user') bgClass = 'bg-blue-600 text-white';
            if (msg.sender === 'system') bgClass = 'bg-slate-800/50 text-slate-400 border border-slate-700 italic text-sm';

            div.innerHTML = `<div class="max-w-[85%] md:max-w-[70%] rounded-2xl p-4 shadow-sm ${bgClass}">${msg.text}</div>`;
            chatContainer.appendChild(div);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function renderKnowledge() {
        if (knowledgeBase.length === 0) {
            knowledgeList.innerHTML = '<p class="text-sm text-slate-500 px-2 italic">No documents uploaded yet.</p>';
            return;
        }
        knowledgeList.innerHTML = knowledgeBase.map(doc => `
            <div class="flex items-center gap-3 p-3 bg-slate-900/50 rounded-xl border border-slate-800">
                <i data-lucide="file-text" class="w-5 h-5 text-blue-400 shrink-0"></i>
                <div class="min-w-0">
                    <p class="text-sm font-medium truncate text-slate-200">${doc.name}</p>
                    <p class="text-[10px] text-slate-500 uppercase">${doc.type.split('/')[1]}</p>
                </div>
            </div>
        `).join('');
        lucide.createIcons();
    }

    // 4. Gemini API Logic
    async function callGemini(prompt, imageData = null) {
        const lang = langSelect.value;
        const kbContext = knowledgeBase.map(d => `[Title: ${d.name}, Summary: ${d.summary}]`).join('. ');
        const systemPrompt = `You are a personalized 'AI Mind'. Language: ${lang}. 
        Context: ${kbContext}. Respond based on context in ${lang}.`;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        let contents = [{ parts: [{ text: prompt }] }];
        if (imageData) {
            contents[0].parts.push({ inlineData: { mimeType: "image/png", data: imageData } });
        }

        const payload = {
            contents: contents,
            systemInstruction: { parts: [{ text: systemPrompt }] }
        };

        for (let i = 0, delay = 1000; i < 5; i++, delay *= 2) {
            try {
                const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                if (res.ok) return data.candidates[0].content.parts[0].text;
            } catch (e) {
                await new Promise(r => setTimeout(r, delay));
            }
        }
        return "Maafi chahta hoon, connection mein samasya hai.";
    }

    // 5. User Actions
    const handleSend = async () => {
        const text = userInput.value.trim();
        if (!text || !currentUser) return;

        userInput.value = '';
        const userMsg = { text, sender: 'user', timestamp: Date.now() };
        await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'chats'), userMsg);

        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'flex justify-start';
        typingIndicator.innerHTML = `<div class="bg-slate-800 rounded-2xl p-4 text-slate-400">Thinking...</div>`;
        chatContainer.appendChild(typingIndicator);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        const aiResponse = await callGemini(text);
        chatContainer.removeChild(typingIndicator);

        await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'chats'), {
            text: aiResponse, sender: 'ai', timestamp: Date.now()
        });
    };

    const handleFileUpload = async (e) => {
        const file = e.target.files[0];
        if (!file || !currentUser) return;

        const reader = new FileReader();
        reader.onload = async (event) => {
            const base64Data = event.target.result.split(',')[1];
            const summary = await callGemini(`Summarize this file so I can remember it: ${file.name}`, file.type.startsWith('image/') ? base64Data : null);

            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'knowledge'), {
                name: file.name, type: file.type, summary: summary, timestamp: Date.now()
            });

            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'chats'), {
                text: `Document uploaded: ${file.name}. Maine iska context yaad kar liya hai.`,
                sender: 'system',
                timestamp: Date.now()
            });
        };
        reader.readAsDataURL(file);
    };

    window.clearMemory = async () => {
        if (!currentUser) return;
        const chats = await getDocs(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'chats'));
        const kb = await getDocs(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'knowledge'));
        chats.forEach(d => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'chats', d.id)));
        kb.forEach(d => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'knowledge', d.id)));
    };

    // Event Bindings
    sendBtn.onclick = handleSend;
    userInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } };
    userInput.oninput = () => {
        sendBtn.classList.toggle('bg-blue-600', userInput.value.trim().length > 0);
        sendBtn.classList.toggle('text-white', userInput.value.trim().length > 0);
    };
    document.getElementById('file-input').onchange = handleFileUpload;

</script>
</body>
</html>