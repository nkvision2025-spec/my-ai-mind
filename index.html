<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Mind - Ultimate Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        :root {
            --bg-main: #0b0f1a;
            --bg-sidebar: #05070a;
            --text-main: #e2e8f0;
            --border-color: #1e293b;
            --card-bg: #111827;
        }
        .light-mode {
            --bg-main: #f8fafc;
            --bg-sidebar: #ffffff;
            --text-main: #0f172a;
            --border-color: #e2e8f0;
            --card-bg: #f1f5f9;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-main); color: var(--text-main); transition: all 0.3s ease; }
        .sidebar { background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .doc-item.selected { background: rgba(37, 99, 235, 0.15); border-color: #3b82f6; }
        .success-btn { background-color: #10b981 !important; }
        .chat-bubble-selected { ring: 2px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .prose p { margin-bottom: 1.25rem; line-height: 1.7; }
    </style>
</head>
<body class="h-screen overflow-hidden">

<div id="app-container" class="h-full flex flex-col">
    <!-- Notification Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl max-w-sm w-full shadow-2xl">
            <h4 id="modal-title" class="text-lg font-bold mb-2 text-white text-center">Message</h4>
            <p id="modal-body" class="text-slate-400 text-sm mb-6 text-center"></p>
            <button id="modal-close" class="w-full py-2.5 bg-blue-600 hover:bg-blue-500 rounded-xl text-sm text-white font-bold transition-all uppercase">OK</button>
        </div>
    </div>

    <!-- Login View -->
    <div id="login-view" class="flex-1 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-900 border border-slate-800 p-10 rounded-[2.5rem] shadow-2xl text-white text-center">
            <div class="flex flex-col items-center mb-8">
                <div class="p-4 bg-blue-600/20 rounded-3xl mb-4">
                    <i data-lucide="brain-circuit" class="w-12 h-12 text-blue-500"></i>
                </div>
                <h1 class="text-2xl font-bold">Project Mind Login</h1>
                <p class="text-slate-400 text-sm">Secure Portal Access</p>
            </div>
            <div class="space-y-4 text-left">
                <input type="text" id="login-id" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 outline-none focus:border-blue-500 text-white" placeholder="User ID (admin or user)">
                <input type="password" id="login-pass" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 outline-none focus:border-blue-500 text-white" placeholder="Password">
                <button id="btn-login" class="w-full bg-blue-600 hover:bg-blue-500 font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-600/20">LOGIN</button>
                <p id="login-error" class="text-red-400 text-xs text-center hidden italic">Aapki details sahi nahi hain!</p>
            </div>
        </div>
    </div>

    <!-- Main View -->
    <div id="main-view" class="hidden flex-1 flex overflow-hidden">
        <aside class="sidebar w-80 flex flex-col hidden md:flex shadow-2xl relative border-r border-slate-800">
            <div class="p-6 border-b border-slate-800 flex items-center justify-between bg-slate-950/20">
                <div class="flex items-center gap-2">
                    <i data-lucide="brain-circuit" class="w-6 h-6 text-blue-500"></i>
                    <span class="font-bold tracking-tight text-white">AI Mind Pro</span>
                </div>
                <button id="btn-logout" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 text-[10px] font-bold transition-all border border-red-500/20">
                    <i data-lucide="log-out" class="w-3.5 h-3.5"></i> Logout
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-6 text-slate-200">
                <div id="role-section" class="space-y-2">
                    <h3 class="text-xs font-bold text-slate-500 uppercase px-2 flex items-center gap-2 tracking-widest">
                        <i data-lucide="settings" class="w-3 h-3 text-blue-500"></i> Master Role
                    </h3>
                    <textarea id="project-instructions" rows="3" class="w-full bg-slate-900/50 border border-slate-800 rounded-xl p-3 text-sm outline-none focus:border-blue-500 resize-none transition-all text-slate-200" placeholder="Instructions..."></textarea>
                    <button id="save-instructions" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xs py-2.5 rounded-lg transition-all font-bold">Update Master Role</button>
                </div>

                <div id="admin-panel" class="space-y-4 border-t border-slate-800 pt-5 hidden">
                    <h3 class="text-xs font-bold text-slate-500 uppercase px-2">Users Manager</h3>
                    <div class="bg-slate-900/40 p-4 rounded-2xl border border-slate-800 space-y-2">
                        <input type="text" id="new-user-id" placeholder="New ID" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-2.5 text-xs outline-none text-white">
                        <input type="password" id="new-user-pass" placeholder="New Pass" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-2.5 text-xs outline-none text-white">
                        <button id="add-user" class="w-full bg-blue-600 text-white text-[10px] py-2 rounded-lg font-bold">Add User</button>
                    </div>
                    <div id="user-list" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar"></div>
                </div>

                <div class="space-y-2 border-t border-slate-800 pt-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase px-2 flex items-center justify-between tracking-widest">
                        Knowledge Base
                        <div class="flex items-center gap-2">
                            <button id="select-all-docs" class="text-[10px] text-blue-500 hover:underline">All</button>
                            <button id="trigger-upload" class="p-1 text-blue-500 hover:text-blue-400 bg-blue-500/10 rounded-md transition-all">
                                <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </h3>
                    <input type="file" id="file-input" class="hidden" multiple accept=".pdf,.doc,.docx,.txt,image/*">
                    <div id="doc-list" class="space-y-2"></div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-800 bg-slate-950/20">
                <div class="flex p-1 bg-slate-900/80 rounded-xl gap-1 border border-slate-800">
                    <button data-mode="doc" class="search-mode-btn flex-1 py-2 text-[10px] rounded-lg font-bold bg-blue-600 text-white">DOCS</button>
                    <button data-mode="web" class="search-mode-btn flex-1 py-2 text-[10px] rounded-lg font-bold text-slate-500">WEB</button>
                    <button data-mode="both" class="search-mode-btn flex-1 py-2 text-[10px] rounded-lg font-bold text-slate-500">BOTH</button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col relative bg-slate-900/30 overflow-hidden">
            <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 backdrop-blur-md sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div id="status-indicator" class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                    <span id="display-user-role" class="text-xs font-bold text-slate-400 uppercase tracking-widest">Active System</span>
                </div>
                
                <div class="flex items-center gap-2">
                    <div id="selection-controls" class="hidden flex items-center gap-2 mr-4 pr-4 border-r border-slate-800">
                        <button id="btn-delete-selected" class="p-2 text-red-400 hover:bg-red-500/10 rounded-lg text-[10px] font-bold uppercase"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Delete</button>
                        <button id="btn-print-selected" class="p-2 text-blue-400 hover:bg-blue-500/10 rounded-lg text-[10px] font-bold uppercase"><i data-lucide="printer" class="w-3.5 h-3.5"></i> Print</button>
                        <button id="btn-cancel-selection" class="p-2 text-slate-500 hover:bg-slate-800 rounded-lg text-[10px] font-bold uppercase">Cancel</button>
                    </div>
                    <button id="theme-toggle" class="p-2.5 hover:bg-slate-800/50 rounded-full text-slate-400 transition-all"><i data-lucide="sun" class="w-5 h-5"></i></button>
                    <div class="w-px h-6 bg-slate-800 mx-1"></div>
                    <button id="export-docx" class="p-2.5 hover:bg-blue-600/10 hover:text-blue-500 rounded-lg text-slate-400 transition-all"><i data-lucide="file-text" class="w-5 h-5"></i></button>
                    <button id="export-pdf" class="p-2.5 hover:bg-red-600/10 hover:text-red-500 rounded-lg text-slate-400 transition-all"><i data-lucide="file-type-2" class="w-5 h-5"></i></button>
                </div>
            </header>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-10 space-y-8 custom-scrollbar">
                <div class="h-full flex flex-col items-center justify-center text-center opacity-10 select-none">
                    <i data-lucide="brain" class="w-24 h-24 mb-4 text-blue-400"></i>
                    <p class="text-3xl font-bold tracking-tighter">AI MIND PORTAL</p>
                </div>
            </div>

            <div class="p-6 bg-gradient-to-t from-slate-950/20 to-transparent">
                <div class="max-w-4xl mx-auto">
                    <div class="relative bg-slate-900/90 border border-slate-800 rounded-[2.5rem] p-3 shadow-2xl backdrop-blur-xl">
                        <textarea id="chat-input" rows="1" class="w-full bg-transparent border-none outline-none py-3 px-6 resize-none text-slate-200 placeholder:text-slate-500 max-h-40 scrollbar-none" placeholder="Koi sawal puchein..."></textarea>
                        
                        <div class="flex items-center justify-between px-3 pb-1 pt-1 border-t border-slate-800/50 mt-2">
                            <div class="flex items-center gap-2">
                                <button id="btn-mic" class="p-3 text-slate-400 hover:text-blue-400 hover:bg-slate-800 rounded-2xl transition-all"><i data-lucide="mic" class="w-5 h-5"></i></button>
                                <button id="btn-audio-stop" class="p-3 text-red-400 bg-red-500/10 rounded-2xl hidden"><i data-lucide="square" class="w-4 h-4"></i></button>
                            </div>
                            <div class="flex items-center gap-3">
                                <span id="current-search-label" class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">DOCS ONLY</span>
                                <button id="btn-send" class="bg-blue-600 hover:bg-blue-500 text-white p-3.5 rounded-2xl transition-all shadow-lg shadow-blue-600/30 group">
                                    <i data-lucide="send" class="w-5 h-5 group-hover:translate-x-0.5 transition-transform"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, doc, setDoc, deleteDoc, getDocs, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- INTEGRATED CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDMTbWH8sKrNOp9LdH-4EufDjMukeELNoY",
        authDomain: "myai-mind.firebaseapp.com",
        projectId: "myai-mind",
        storageBucket: "myai-mind.firebasestorage.app",
        messagingSenderId: "79456867450",
        appId: "1:79456867450:web:2b2a1eec01c7b420cb97c3"
    };
    const apiKey = "AIzaSyAxJiKA_Xo5YXjIiLMuIa1Qgk9sp5G-V2o"; 
    const appId = 'html-ai-mind-001';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userRole = 'user';
    let searchMode = 'doc';
    let messages = [];
    let knowledgeBase = [];
    let usersList = [];
    let selectedDocIds = new Set();
    let selectedChatIds = new Set();
    let activeUserId = localStorage.getItem('portal_id') || null;
    let synthesis = window.speechSynthesis;

    lucide.createIcons();

    // 1. Auth & Session (Rule 3)
    const initAuth = async () => {
        try { 
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else { await signInAnonymously(auth); }
            return true; 
        } catch (e) { return false; }
    };

    const login = async () => {
        const id = document.getElementById('login-id').value.trim();
        const pass = document.getElementById('login-pass').value.trim();
        const errorEl = document.getElementById('login-error');
        if (!auth.currentUser) await initAuth();

        if (id === 'admin' && pass === 'admin123') {
            userRole = 'admin'; activeUserId = 'admin';
            localStorage.setItem('portal_role', 'admin'); localStorage.setItem('portal_id', 'admin');
            showMain();
        } else {
            try {
                // Rule 1 Public Data path
                const q = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                const found = q.docs.find(d => d.data().userId === id && d.data().password === pass);
                if (found) {
                    userRole = 'user'; activeUserId = id;
                    localStorage.setItem('portal_role', 'user'); localStorage.setItem('portal_id', id);
                    showMain();
                } else { errorEl.classList.remove('hidden'); }
            } catch (e) { errorEl.classList.remove('hidden'); }
        }
    };

    const showMain = () => {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        initDashboard();
    };

    function initDashboard() {
        userRole = localStorage.getItem('portal_role') || 'user';
        activeUserId = localStorage.getItem('portal_id');
        document.getElementById('display-user-role').innerText = `ROLE: ${userRole.toUpperCase()} (${activeUserId})`;
        if (userRole === 'admin') document.getElementById('admin-panel').classList.remove('hidden');
        setupListeners();
    }

    let unsubSettings, unsubUsers, unsubKB, unsubChat;
    async function setupListeners() {
        if (!auth.currentUser || !activeUserId) return;
        if (unsubSettings) unsubSettings(); if (unsubUsers) unsubUsers(); if (unsubKB) unsubKB(); if (unsubChat) unsubChat();

        unsubSettings = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), (s) => {
            if (s.exists()) document.getElementById('project-instructions').value = s.data().instructions;
        });

        if (userRole === 'admin') {
            unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snapshot) => {
                usersList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderUserList(); renderDocList();
            });
        } else {
            const q = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            usersList = q.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        unsubKB = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'knowledge'), (snapshot) => {
            knowledgeBase = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderDocList(); if(userRole === 'admin') renderUserList();
        });

        const chatColl = `chats_${activeUserId}`;
        unsubChat = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', chatColl), (snapshot) => {
            messages = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.timestamp - b.timestamp);
            renderChat();
        });
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) { if (localStorage.getItem('portal_id')) showMain(); } else { await initAuth(); }
    });

    // --- REFINED AI LOGIC (TIMEOUT & ERROR PROTECTION) ---
    async function callAI(prompt, fileData = null, mimeType = null, isIndexing = false) {
        const masterInstr = document.getElementById('project-instructions').value;
        const selDocs = knowledgeBase.filter(d => selectedDocIds.has(d.id));
        const docRoles = selDocs.map(d => d.role ? `[Instruction for ${d.name}: ${d.role}]` : '').join('\n');
        const context = selDocs.map(d => `[Summary of ${d.name}: ${d.summary}]`).join('\n\n');
        const isSearchEnabled = (searchMode !== 'doc' && !isIndexing);
        
        const systemPrompt = `Master Role: ${masterInstr}\nDoc Roles: ${docRoles}\nKnowledge Context: ${context}\n\nMODE: ${searchMode}. Answer only from context if doc mode. Format in paragraphs. Be helpful.`;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { 
            contents: [{ parts: [{ text: prompt }] }], 
            systemInstruction: { parts: [{ text: systemPrompt }] },
            tools: isSearchEnabled ? [{ "google_search": {} }] : [] 
        };

        if (fileData) payload.contents[0].parts.push({ inlineData: { mimeType, data: fileData } });

        let delay = 2000;
        for (let i = 0; i < 4; i++) {
            try {
                const ctrl = new AbortController();
                const tid = setTimeout(() => ctrl.abort(), 110000); // 110 seconds for large docs
                const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload), signal: ctrl.signal });
                clearTimeout(tid);
                if (!res.ok) throw new Error("API fail");
                const data = await res.json();
                return { text: data.candidates?.[0]?.content?.parts?.[0]?.text || "No response received.", sources: [] };
            } catch (e) {
                if (i === 3) return { text: "Connection error. Badi file process karte waqt timeout ho sakta hai. Kripya choti file try karein ya internet check karein.", sources: [] };
                await new Promise(r => setTimeout(r, delay)); delay *= 2;
            }
        }
    }

    // Handlers
    document.getElementById('btn-login').onclick = login;
    document.getElementById('btn-logout').onclick = () => { auth.signOut(); localStorage.clear(); location.reload(); };

    document.getElementById('btn-send').onclick = async () => {
        const text = document.getElementById('chat-input').value.trim();
        if (!text || !auth.currentUser || !activeUserId) return;
        document.getElementById('chat-input').value = '';
        const chatColl = `chats_${activeUserId}`;
        
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', chatColl), { text, sender: 'user', timestamp: Date.now() });
        const thinkingMsg = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', chatColl), { text: "Thinking...", sender: 'system', timestamp: Date.now() });
        
        const res = await callAI(text);
        
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', chatColl, thinkingMsg.id));
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', chatColl), { text: res.text, sender: 'ai', timestamp: Date.now() });
    };

    // Fix for iFrame upload trigger
    document.getElementById('trigger-upload').onclick = () => document.getElementById('file-input').click();

    document.getElementById('file-input').onchange = async (e) => {
        const files = Array.from(e.target.files); if (!auth.currentUser || !activeUserId) return;
        const chatColl = `chats_${activeUserId}`;
        for (const file of files) {
            const reader = new FileReader();
            const procBubble = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', chatColl), { text: `AI is analyzing ${file.name}... Please wait.`, sender: 'system', timestamp: Date.now() });
            reader.onload = async (ev) => {
                const b64 = ev.target.result.split(',')[1];
                const res = await callAI(`Summarize this document fully so I can recall it: ${file.name}`, b64, file.type, true);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'knowledge'), { name: file.name, type: file.type, summary: res.text, role: '', timestamp: Date.now() });
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', chatColl, procBubble.id));
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', chatColl), { text: `Upload successfully for "${file.name}". Now I am ready to chat.`, sender: 'ai', timestamp: Date.now() });
            };
            reader.readAsDataURL(file);
        }
    };

    // UI Renders
    function renderChat() {
        const chatBox = document.getElementById('chat-messages');
        if (messages.length > 0) {
            chatBox.innerHTML = messages.map(m => {
                const isSelected = selectedChatIds.has(m.id);
                const isUser = m.sender === 'user';
                const isSystem = m.sender === 'system';
                return `<div class="flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''} group">
                    <div class="pt-2"><input type="checkbox" class="w-4 h-4 rounded accent-blue-600 cursor-pointer" ${isSelected ? 'checked' : ''} onchange="toggleChatSelection('${m.id}')"></div>
                    <div class="max-w-[85%] md:max-w-[75%] rounded-3xl p-5 shadow-xl transition-all ${isSelected ? 'chat-bubble-selected ring-2 ring-blue-500' : ''} ${isUser ? 'bg-blue-600 text-white rounded-tr-none' : isSystem ? 'bg-slate-800/40 text-slate-400 italic text-xs' : 'bg-slate-900 border border-slate-800 rounded-tl-none'}">
                        <div class="prose prose-invert prose-sm whitespace-pre-wrap">${m.text}</div>
                        ${m.sender === 'ai' ? `<button onclick="speakText('${m.id}')" class="mt-4 p-2.5 hover:bg-slate-800 rounded-xl text-slate-500 transition-all"><i data-lucide="volume-2" class="w-4 h-4"></i></button>` : ''}
                    </div>
                </div>`;
            }).join('');
        } else {
            chatBox.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center opacity-10"><i data-lucide="brain" class="w-24 h-24 mb-4 text-blue-400"></i><p class="text-3xl font-bold tracking-tighter">AI MIND PORTAL</p></div>`;
        }
        lucide.createIcons(); chatBox.scrollTop = chatBox.scrollHeight;
        updateSelectionUI();
    }

    function renderUserList() {
        const list = document.getElementById('user-list');
        list.innerHTML = usersList.map(u => `
            <div class="bg-slate-900/60 p-4 rounded-xl border border-slate-800 space-y-3">
                <div class="flex items-center justify-between"><span class="text-xs font-bold text-blue-400">${u.userId}</span><button onclick="deleteUser('${u.id}')" class="text-red-500 hover:text-red-400 transition-all"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>
                <div class="grid grid-cols-1 gap-1 max-h-32 overflow-y-auto custom-scrollbar p-1">
                    ${knowledgeBase.map(d => `<label class="flex items-center gap-2 p-1.5 rounded bg-slate-950 border border-slate-800 cursor-pointer transition-all"><input type="checkbox" class="w-3 h-3 accent-blue-600" ${u.allowedDocs?.includes(d.id) ? 'checked' : ''} onchange="toggleUserDoc('${u.id}', '${d.id}')"><span class="text-[9px] truncate text-slate-300">${d.name}</span></label>`).join('')}
                </div>
            </div>
        `).join('');
        lucide.createIcons();
    }

    function renderDocList() {
        const uId = localStorage.getItem('portal_id');
        const userFound = usersList.find(u => u.userId === uId);
        let visibleDocs = userRole === 'admin' ? knowledgeBase : knowledgeBase.filter(d => userFound?.allowedDocs?.includes(d.id));
        
        document.getElementById('doc-list').innerHTML = visibleDocs.map(d => `
            <div class="group flex flex-col gap-2 p-3 rounded-xl border border-slate-800 cursor-pointer doc-item transition-all ${selectedDocIds.has(d.id) ? 'selected' : ''}" onclick="toggleDocSelection('${d.id}')">
                <div class="flex items-center gap-2"><input type="checkbox" class="w-4 h-4 rounded accent-blue-600 pointer-events-none" ${selectedDocIds.has(d.id) ? 'checked' : ''}><p class="text-[11px] font-bold truncate flex-1">${d.name}</p>${userRole === 'admin' ? `<button onclick="event.stopPropagation(); deleteDocById('${d.id}')" class="opacity-0 group-hover:opacity-100 text-red-500 transition-all"><i data-lucide="trash-2" class="w-3 h-3"></i></button>` : ''}</div>
                ${selectedDocIds.has(d.id) ? `<div class="space-y-1.5" onclick="event.stopPropagation()"><textarea id="instr-${d.id}" class="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-[9px] text-slate-400 h-16 resize-none outline-none focus:border-blue-500" placeholder="Doc role...">${d.role || ''}</textarea><button onclick="updateDocRole('${d.id}')" class="w-full bg-blue-600/20 text-blue-400 py-1 rounded text-[9px] font-bold uppercase transition-all">Save</button></div>` : ''}
            </div>
        `).join('');
        lucide.createIcons();
    }

    // Helper Functions
    window.toggleChatSelection = (id) => { if (selectedChatIds.has(id)) selectedChatIds.delete(id); else selectedChatIds.add(id); renderChat(); };
    function updateSelectionUI() { const ctrl = document.getElementById('selection-controls'); if (selectedChatIds.size > 0) ctrl.classList.remove('hidden'); else ctrl.classList.add('hidden'); }
    window.toggleDocSelection = (id) => { if (selectedDocIds.has(id)) selectedDocIds.delete(id); else selectedDocIds.add(id); renderDocList(); };
    window.deleteUser = async (id) => { if (!auth.currentUser) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id)); };
    window.deleteDocById = async (id) => { if (!auth.currentUser) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id)); };
    window.updateDocRole = async (id) => { const val = document.getElementById(`instr-${id}`).value; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'knowledge', id), { role: val }); renderDocList(); };
    
    document.getElementById('btn-delete-selected').onclick = async () => {
        if (!auth.currentUser || selectedChatIds.size === 0) return;
        const chatColl = `chats_${activeUserId}`;
        const ids = Array.from(selectedChatIds); selectedChatIds.clear();
        for (let id of ids) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', chatColl, id));
    };

    document.getElementById('theme-toggle').onclick = () => {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        document.getElementById('theme-toggle').innerHTML = `<i data-lucide="${isLight ? 'moon' : 'sun'}" class="w-5 h-5"></i>`;
        lucide.createIcons();
    };

    document.querySelectorAll('.search-mode-btn').forEach(btn => {
        btn.onclick = (e) => {
            searchMode = e.target.dataset.mode;
            document.querySelectorAll('.search-mode-btn').forEach(b => { b.classList.remove('bg-blue-600', 'text-white'); b.classList.add('text-slate-500'); });
            e.target.classList.add('bg-blue-600', 'text-white');
            document.getElementById('current-search-label').innerText = `${searchMode.toUpperCase()} MODE`;
        };
    });

</script>
</body>
</html>
